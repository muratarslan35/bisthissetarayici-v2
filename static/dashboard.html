<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BIST Tarayıcı Dashboard</title>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; margin:16px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #ddd; padding:8px; text-align:center}
    th{background:#f4f4f4}
    .small{font-size:0.9em; color:#666}
  </style>
</head>
<body>
  <h2>BIST Tarayıcı</h2>
  <div class="small">Son güncelleme: <span id="updated">-</span></div>
  <table id="tbl">
    <thead>
      <tr><th>Sembol</th><th>Fiyat</th><th>RSI</th><th>Trend</th><th>Günlük</th><th>Hacim</th><th>Sinyaller</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function refresh(){
  try{
    const res = await fetch('/api');
    const js = await res.json();
    document.getElementById('updated').innerText = new Date(js.timestamp*1000).toLocaleString();
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    if(js.data && js.data.length){
      js.data.forEach(it=>{
        const row = document.createElement('tr');
        const signals = [];
        if(it.RSI !== undefined) signals.push('RSI:'+it.RSI.toFixed(2));
        if(it.last_signal) signals.push(it.last_signal);
        if(it.support_break) signals.push('Support↓');
        if(it.resistance_break) signals.push('Resistance↑');
        if(it.three_peak_break) signals.push('3peak');
        if(it.green_mum_11) signals.push('G11');
        if(it.green_mum_15) signals.push('G15');
        if(it.ma_breaks){
          Object.keys(it.ma_breaks).forEach(k=>{
            const v = it.ma_breaks[k];
            if(v) signals.push(`${k}:${v}`);
          });
        }
        row.innerHTML = `<td>${it.symbol}</td><td>${it.current_price?.toFixed?.(2) ?? it.current_price}</td><td>${it.RSI?.toFixed?.(2) ?? '-'}</td><td>${it.trend ?? '-'}</td><td>${it.daily_change ?? '-'}</td><td>${it.volume ?? '-'}</td><td>${signals.join(' | ')}</td>`;
        tbody.appendChild(row);
      });
    }
  }catch(e){
    console.error(e);
  } finally{
    setTimeout(refresh, 60000);
  }
}
refresh();
</script>
</body>
</html>

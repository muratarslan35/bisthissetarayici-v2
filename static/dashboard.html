<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>BIST Algo Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- GOOGLE FONTS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: #0d1117;
        color: #e6edf3;
        margin: 0;
        padding: 0;
    }

    h1 {
        text-align: center;
        font-weight: 600;
        margin-top: 20px;
        color: #58a6ff;
    }

    /* Ãœst bar */
    .top-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        background: #161b22;
        padding: 10px 15px;
        border-bottom: 1px solid #30363d;
        font-size: 14px;
    }

    .filter-box {
        background: #161b22;
        padding: 10px;
        margin: 10px;
        border-radius: 8px;
        border: 1px solid #30363d;
    }

    select, input {
        background: #0d1117;
        color: white;
        border: 1px solid #30363d;
        padding: 6px;
        border-radius: 5px;
        margin-right: 10px;
        margin-top: 5px;
    }

    .signal-container {
        margin: 20px;
    }

    .signal-card {
        background: #161b22;
        border-left: 5px solid #58a6ff;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        transition: 0.3s;
    }

    .signal-card.flash {
        animation: flash 1.2s ease-out;
    }

    @keyframes flash {
        0% { background: #2ea04360; }
        100% { background: #161b22; }
    }

    /* sinyal renkleri */
    .green { border-color: #2ea043; }
    .red { border-color: #f85149; }
    .yellow { border-color: #e3b341; }

    .chartCanvas {
        width: 100%;
        height: 45px;
    }

    @media (max-width: 600px) {
        .signal-card { font-size: 13px; }
        select, input { width: 100%; margin-bottom: 8px; }
    }
</style>

</head>
<body>

<h1>ðŸ“ˆ BIST Algo Dashboard</h1>

<div class="top-bar">
    <div>ðŸ”„ Son Tarama: <span id="scanTime">YÃ¼kleniyor...</span></div>
    <div>ðŸ“¥ Son Veri: <span id="fetchTime">YÃ¼kleniyor...</span></div>
</div>

<div class="filter-box">
    <strong>Filtreler:</strong><br>
    <select id="symbolFilter">
        <option value="">Hisse SeÃ§</option>
    </select>

    <select id="signalFilter">
        <option value="">Sinyal TÃ¼rÃ¼</option>
        <option value="green">YeÅŸil Sinyal</option>
        <option value="red">KÄ±rmÄ±zÄ± Sinyal</option>
        <option value="yellow">UyarÄ±</option>
    </select>

    <input type="number" id="rsiMin" placeholder="RSI min" style="width:90px;">
    <input type="number" id="rsiMax" placeholder="RSI max" style="width:90px;">
</div>

<div class="signal-container" id="signalContainer">
    <p style="text-align:center;color:#777;">Sinyaller yÃ¼kleniyor...</p>
</div>

<script>
async function loadSignals() {
    const res = await fetch("/latest-data");
    if (!res.ok) return;
    const data = await res.json();

    // dashboard Ã§alÄ±ÅŸmasÄ± iÃ§in zorunlu: app.py'de doÄŸru json gÃ¶nderiliyor
    const signals = data.signals || [];
    const scan_time = data.last_scan || "â€”";
    const fetch_time = data.last_fetch || "â€”";

    document.getElementById("scanTime").innerText = scan_time;
    document.getElementById("fetchTime").innerText = fetch_time;

    // Hisse filtre dropdown doldur
    const symbolSelect = document.getElementById("symbolFilter");
    const uniqueSymbols = [...new Set(signals.map(s => s.symbol))];
    symbolSelect.innerHTML = `<option value="">Hisse SeÃ§</option>`;
    uniqueSymbols.forEach(sym => {
        symbolSelect.innerHTML += `<option value="${sym}">${sym}</option>`;
    });

    renderSignals(signals);
}

function renderSignals(signals) {

    const container = document.getElementById("signalContainer");
    container.innerHTML = "";

    if (signals.length === 0) {
        container.innerHTML = `<p style='text-align:center;color:#777;'>HenÃ¼z sinyal yok...</p>`;
        return;
    }

    const sFilter = document.getElementById("symbolFilter").value;
    const sigFilter = document.getElementById("signalFilter").value;
    const rsiMin = parseFloat(document.getElementById("rsiMin").value);
    const rsiMax = parseFloat(document.getElementById("rsiMax").value);

    signals.forEach(sig => {

        // FÄ°LTRELER
        if (sFilter && sig.symbol !== sFilter) return;
        if (sigFilter && sig.color !== sigFilter) return;
        if (!isNaN(rsiMin) && sig.rsi < rsiMin) return;
        if (!isNaN(rsiMax) && sig.rsi > rsiMax) return;

        const div = document.createElement("div");
        div.className = `signal-card ${sig.color} flash`;

        div.innerHTML = `
            <strong>${sig.symbol}</strong> â€” ${sig.type}<br>
            Fiyat: <b>${sig.price}</b> | RSI: <b>${sig.rsi.toFixed(2)}</b> | Trend: <b>${sig.trend}</b><br>
            <small>${sig.time}</small>
            <canvas class="chartCanvas" id="chart_${sig.symbol}"></canvas>
        `;

        container.appendChild(div);

        // KÃ¼Ã§Ã¼k sparkline chart (fiyat yÃ¶nÃ¼ gÃ¶sterir)
        drawMiniChart(`chart_${sig.symbol}`, sig.spark || []);
    });
}

function drawMiniChart(canvasId, data) {
    if (!data || data.length === 0) return;

    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");

    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);

    const max = Math.max(...data);
    const min = Math.min(...data);

    ctx.beginPath();
    data.forEach((val, i) => {
        let x = (i / (data.length - 1)) * w;
        let y = h - ((val - min) / (max - min)) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.strokeStyle = data[data.length - 1] >= data[0] ? "#2ea043" : "#f85149";
    ctx.lineWidth = 2;
    ctx.stroke();
}

setInterval(loadSignals, 4000);
loadSignals();

</script>

</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BIST Tarayıcı Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Arial; margin:12px; color:#111;}
    h1{margin-bottom:8px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;border:1px solid #e6e6e6;text-align:left;font-size:13px;}
    th{background:#f7f7f7;position:sticky;top:0;}
    .small{font-size:12px;color:#666;}
    .ok{background:#e6ffed;}
    .warn{background:#fff7e6;}
    .bad{background:#ffe6e6;}
    #last {margin-bottom:12px;color:#333;}
  </style>
</head>
<body>
  <h1>BIST Tarayıcı</h1>
  <div id="last" class="small">Veri bekleniyor...</div>
  <table id="tbl">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Fiyat</th>
        <th>RSI</th>
        <th>Sinyal</th>
        <th>Trend</th>
        <th>MA Kırılımları</th>
        <th>Günlük %</th>
        <th>Hacim</th>
        <th>Zaman</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>

<script>
async function fetchAndRender(){
  try{
    const res = await fetch('/api');
    const js = await res.json();
    const body = document.getElementById('body');
    body.innerHTML = '';
    if(js.status !== 'ok' || !js.data){
      document.getElementById('last').innerText = 'API durumu: ' + js.status;
      return;
    }
    document.getElementById('last').innerText = 'Güncelleme: ' + new Date(js.timestamp*1000).toLocaleString();
    js.data.forEach(item=>{
      const tr = document.createElement('tr');
      const ma_breaks = item.ma_breaks || {};
      let maText = Object.entries(ma_breaks).filter(([k,v])=>v).map(([k])=>k).join(', ') || '-';
      let rsiClass = item.RSI !== null ? (item.RSI < 25 ? 'ok' : (item.RSI>75 ? 'bad' : '')) : '';
      tr.innerHTML = `
        <td>${item.symbol}</td>
        <td>${item.current_price ?? '-'}</td>
        <td class="${rsiClass}">${item.RSI ?? '-'}</td>
        <td>${item.last_signal ?? '-'}</td>
        <td>${item.trend ?? '-'}</td>
        <td>${maText}</td>
        <td>${item.daily_change ?? '-'}</td>
        <td>${item.volume ?? '-'}</td>
        <td>${item.signal_time ?? '-'}</td>
      `;
      body.appendChild(tr);
    });
  }catch(err){
    document.getElementById('last').innerText = 'Hata: ' + err;
  }
}
fetchAndRender();
setInterval(fetchAndRender, 60*1000);
</script>
</body>
</html>

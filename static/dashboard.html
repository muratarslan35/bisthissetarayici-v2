<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIST Tarayıcı Dashboard</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 12px; background:#f7f9fc; color:#222; }
    h1 { margin: 8px 0 14px; font-size:24px; }
    table { width:100%; border-collapse: collapse; background:white; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
    th, td { padding:8px 10px; text-align:left; border-bottom:1px solid #eee; font-size:13px; }
    th { background:#fafafa; position: sticky; top:0; z-index:2; }
    tr:hover { background:#f1f7ff; }
    .small { font-size:12px; color:#666; }
    .ok { color:green; font-weight:600; }
    .bad { color:red; font-weight:600; }
    #status { margin-bottom:8px; }
    .wrap { max-width:1200px; margin:0 auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BIST Tarayıcı Dashboard</h1>
    <div id="status" class="small">Durum: <span id="status_text">yükleniyor...</span></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Sembol</th>
          <th>Fiyat</th>
          <th>RSI</th>
          <th>Signal</th>
          <th>Trend</th>
          <th>Günlük Değişim</th>
          <th>Hacim</th>
          <th>MA20/50/100/200</th>
          <th>Support/Resistance</th>
          <th>Zaman</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function fetchData(){
      try {
        let r = await fetch('/api');
        let j = await r.json();
        document.getElementById('status_text').innerText = j.status + ' — ' + (j.timestamp ? new Date(j.timestamp*1000).toLocaleString() : '');
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        if (!j.data || j.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="small">Henüz veri yok.</td></tr>';
          return;
        }
        j.data.forEach(item=>{
          const ma_vals = item.ma_values ? Object.values(item.ma_values).map(v => v ? v.toFixed(2) : '-') : [];
          const ma_text = ma_vals.join(' / ');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.symbol}</td>
            <td>${item.current_price ?? '-'}</td>
            <td>${item.RSI ? item.RSI.toFixed(2) : '-'}</td>
            <td>${item.last_signal ?? '-'}</td>
            <td>${item.trend ?? '-'}</td>
            <td>${item.daily_change ?? '-'}</td>
            <td>${item.volume ?? '-'}</td>
            <td>${ma_text}</td>
            <td>${item.support_break ? 'Destek kırıldı' : (item.resistance_break ? 'Direnç kırıldı' : '-')}</td>
            <td>${item.signal_time ?? '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        document.getElementById('status_text').innerText = 'hata: ' + e;
      }
    }
    fetchData();
    setInterval(fetchData, 10000);
  </script>
</body>
</html>
